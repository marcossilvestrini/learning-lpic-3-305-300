#cloud-config
# runcmd:
#   - [eval, 'echo $(cat /proc/cmdline) "autoinstall" > /root/cmdline']
#   - [eval, "mount -n --bind -o ro /root/cmdline /proc/cmdline"]
#   - [eval, "snap restart subiquity.subiquity-server"]
#   - [eval, "snap restart subiquity.subiquity-service"]

autoinstall:
  version: 1
  identity:
    hostname: lpic3-hvm-guest
    username: vagrant
    password: "vagrant"

  users:
    - name: root
      lock_passwd: false
      plain_text_passwd: "vagrant"
    - name: vagrant
      gecos: "Vagrant User"
      primary_group: users
      groups: sudo
      shell: /bin/bash
      sudo: ["ALL=(ALL) NOPASSWD:ALL"]
      lock_passwd: false
      plain_text_passwd: "vagrant"

  ssh:
    install-server: true
    allow-pw: true
    authorized-keys:
      - ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAFXTn6ne9bCnJcmDSPZgql9HicNpukOv3fotZA+CgV0f0CK4Zoun4C6fcSh1esLmDGHMIxzjZ1ayDKXdtWKrX7YEQFGcw2DFHl1fsE88pQLE2Ppu4+NROVxl0TKdZvZxnpVEqLommJf4Z7EQyAd1gw1z+J9W+OuSDD8ME5feZ0gi1vhPA== vagrant@kubernetes

  storage:
    layout:
      name: lvm
    config:
      - id: disk-xvda
        type: disk
        match:
          size: largest
        ptable: gpt
        wipe: superblock
        preserve: false
        grub_device: true
      - id: partition-boot
        type: partition
        device: disk-xvda
        size: 512M
        flag: boot
      - id: partition-root
        type: partition
        device: disk-xvda
        size: -1
      - id: lvm-vg
        type: lvm_volgroup
        name: vg_root
        devices: [partition-root]
      - id: lvm-lv-root
        type: lvm_partition
        volgroup: lvm-vg
        size: -1
        name: lv_root
      - id: format-root
        type: format
        fstype: ext4
        volume: lvm-lv-root
      - id: mount-root
        type: mount
        device: format-root
        path: /

  network:
    version: 2
    ethernets:
      enX0:
        dhcp4: true
        dhcp6: false
        optional: true
        nameservers:
          addresses:
            - 8.8.8.8
            - 8.8.4.4

  packages:
    - openssh-server
    - net-tools

  late-commands:
    # - "umount -lf /cdrom || true"
    # - "umount -lf /target/cdrom || true"
    # - "losetup -D || true"
    # - curtin in-target -- sh -c "echo 'root:vagrant' | chpasswd"
    # - curtin in-target -- sh -c "echo 'vagrant:vagrant' | chpasswd"
    # - curtin in-target -- usermod -aG sudo vagrant
    - curtin in-target -- sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
